# ðŸ“‚ .github/workflows/discord.yml
name: GitHub â†’ Discord Webhook

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, closed, reopened, synchronize, merged]

jobs:
  notifyDiscord:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_EVENT: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          # Default values
          COLOR=3447003
          AUTHOR_URL="https://github.com/$GITHUB_ACTOR"
          AUTHOR_ICON="https://github.com/$GITHUB_ACTOR.png"

          if [ "$GITHUB_EVENT" = "push" ]; then
            COLOR=5763719
            BRANCH=$(jq -r '.ref' $GITHUB_EVENT_PATH | sed 's/refs\/heads\///')
            COMMIT_URL="https://github.com/$REPO/commit/$SHA"
            COMMIT_MSG=$(jq -r '.head_commit.message' $GITHUB_EVENT_PATH)
            TITLE="Push to branch: $BRANCH"
            DESCRIPTION="**Commit Message:**\`\`\`$COMMIT_MSG\`\`\`[View Commit]($COMMIT_URL)"
          elif [ "$GITHUB_EVENT" = "pull_request" ]; then
            PR_TITLE=$(jq -r '.pull_request.title' $GITHUB_EVENT_PATH)
            NUMBER=$(jq -r '.pull_request.number' $GITHUB_EVENT_PATH)
            ACTION=$(jq -r '.action' $GITHUB_EVENT_PATH)
            URL=$(jq -r '.pull_request.html_url' $GITHUB_EVENT_PATH)
            COLOR=15158332
            TITLE="Pull Request $ACTION"
            DESCRIPTION="**Title:** $PR_TITLE**PR Number:** #$NUMBER[View Pull Request]($URL)"
          else
            TITLE="Repository Event"
            DESCRIPTION="**$GITHUB_ACTOR** triggered: $GITHUB_EVENT"
          fi

          # Build JSON payload for Discord embed
          JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --arg actor "$GITHUB_ACTOR" \
            --arg actorUrl "$AUTHOR_URL" \
            --arg actorIcon "$AUTHOR_ICON" \
            --arg repo "$REPO" \
            --argjson color $COLOR \
            '{embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                author: {name: $actor, url: $actorUrl, icon_url: $actorIcon},
                footer: {text: $repo},
                timestamp: (now | todate)
            }]}')

          # Send to Discord webhook
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON" \
               $DISCORD_WEBHOOK
