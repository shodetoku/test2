name: Discord GitHub Notifications

on:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT_NAME="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          AVATAR_URL="https://github.com/${{ github.actor }}.png"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          TIME="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          STATUS="success"
          COLOR=3066993   # green
          TITLE=""
          MESSAGE=""
          URL=""

          if [ "$EVENT_NAME" = "push" ]; then
            TITLE="Push Event"
            MESSAGE="${{ github.event.head_commit.message }}"
            URL="${{ github.event.head_commit.url }}"
          else
            # Pull Request event
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            ACTION="${{ github.event.action }}"

            TITLE="Pull Request ($ACTION)"
            MESSAGE="$PR_TITLE"
            URL="$PR_URL"
          fi

          # If job fails, change status (this is future-proof if you add tests/builds later)
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="failed"
            COLOR=15158332   # red
          fi

          if [ "$STATUS" = "success" ]; then
            STATUS_TEXT="✅ Success"
          else
            STATUS_TEXT="❌ Failed"
          fi

          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"username\": \"GitHub Bot\",
            \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
            \"embeds\": [{
              \"author\": {
                \"name\": \"$ACTOR\",
                \"icon_url\": \"$AVATAR_URL\"
              },
              \"title\": \"$TITLE\",
              \"url\": \"$URL\",
              \"color\": $COLOR,
              \"fields\": [
                { \"name\": \"Repository\", \"value\": \"$REPO\", \"inline\": true },
                { \"name\": \"Branch\", \"value\": \"$BRANCH\", \"inline\": true },
                { \"name\": \"Message\", \"value\": \"$MESSAGE\", \"inline\": false },
                { \"name\": \"Status\", \"value\": \"$STATUS_TEXT\", \"inline\": true },
                { \"name\": \"Time\", \"value\": \"$TIME\", \"inline\": true }
              ],
              \"footer\": {
                \"text\": \"GitHub Actions → Discord\"
              }
            }]
          }" \
          $DISCORD_WEBHOOK
